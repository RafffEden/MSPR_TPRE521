# -*- coding: utf-8 -*-
import dataiku
import pandas as pd, numpy as np
from dataiku import pandasutils as pdu
import cv2
from skimage.feature import hog
import os
import hashlib

# Read recipe inputs
Lynx = dataiku.Folder("kVfHU9G6")
Lynx_info = Lynx.get_info()
Castor = dataiku.Folder("o73V1WLD")
Castor_info = Castor.get_info()
Chien = dataiku.Folder("Ne735Hba")
Chien_info = Chien.get_info()
Chat = dataiku.Folder("Wqic3nLC")
Chat_info = Chat.get_info()
Coyote = dataiku.Folder("5ZdGXH8x")
Coyote_info = Coyote.get_info()
Ecureuil = dataiku.Folder("4olYiLA0")
Ecureuil_info = Ecureuil.get_info()
Lapin = dataiku.Folder("BupQa5Uz")
Lapin_info = Lapin.get_info()
Loup = dataiku.Folder("akyN5o5h")
Loup_info = Loup.get_info()
Ours = dataiku.Folder("oPS1riCi")
Ours_info = Ours.get_info()
Puma = dataiku.Folder("pzMqdhDh")
Puma_info = Puma.get_info()
Rat = dataiku.Folder("duKSm9uU")
Rat_info = Rat.get_info()
Raton_Laveur = dataiku.Folder("S4XYEjTg")
Raton_Laveur_info = Raton_Laveur.get_info()
Renard = dataiku.Folder("1zb4VSaI")
Renard_info = Renard.get_info()



# Function to load and preprocess images
def load_images(folder_path):
    images = []
    for filename in os.listdir(folder_path):
        img_path = os.path.join(folder_path, filename)
        img = cv2.imread(img_path, cv2.IMREAD_GRAYSCALE)
        resized_img = cv2.resize(img, (128, 64))  # Resize images to a common size
        images.append(resized_img)
    return images

folders = [Lynx, Castor, Chien, Chat, Coyote, Ecureuil, 
               Lapin, Loup, Ours, Puma, Rat, Raton_Laveur, Renard]

def hashage(img):
    with open(img, 'rb') as b_img :
        hash_img = hashlib.sha256(b_img.read()).digest()
    return hash_img
    
Mammiferes_df = pd.DataFrame(columns=['target', 'path', 'hash'])
Data = pd.DataFrame()
for folder in folders:
    images = load_images(folder.get_path())
    for img in images :
        hash_img = hashage(img)
        Data = Data.append([hash_img,hog(img, orientation = 9, pixels_per_cells= (8,8), cells_per_block=(2,2))])
        Mammiferes_df=Mammiferes_df.append({'target': folder.get_name(), 'path': img, 'hash': hash_img}, ignore_index = True)
        
Data['hash'] = Mammiferes_df['hash']
Mammiferes_df = pd.merge(Mammiferes_df, Data, on = 'hash', how ='left' )

Mammiferes = dataiku.Dataset("Mammiferes")
Mammiferes.write_with_schema(Mammiferes_df)
